#!/usr/bin/with-contenv bash
set -euo pipefail

LOG="/var/log/tailscale-init.log"
exec >>"$LOG" 2>&1

echo "[tailscale-init] $(date -Is) starting"

if [[ -z "${TS_AUTHKEY:-}" ]]; then
  echo "[tailscale-init] TS_AUTHKEY not set; skipping"
  exit 0
fi

mkdir -p /var/run/tailscale
chmod 0755 /var/run/tailscale

# Start tailscaled (memory-only state, disposable)
if ! pgrep -x tailscaled >/dev/null 2>&1; then
  echo "[tailscale-init] starting tailscaled"
  /usr/sbin/tailscaled \
    --state=mem: \
    --socket=/var/run/tailscale/tailscaled.sock \
    >/var/log/tailscaled.log 2>&1 &
fi

# Wait for socket
for i in $(seq 1 100); do
  [[ -S /var/run/tailscale/tailscaled.sock ]] && break
  sleep 0.1
done

HOSTNAME_ARG="--hostname=${TS_HOSTNAME:-chromium-ts}"
EXTRA_ARGS="${TS_EXTRA_ARGS:-}"

echo "[tailscale-init] tailscale up ${HOSTNAME_ARG} ${EXTRA_ARGS}"
tailscale up --authkey="${TS_AUTHKEY}" ${HOSTNAME_ARG} ${EXTRA_ARGS} || true

# Logout on container stop: cont-finish hook is honored on LSIO images
mkdir -p /etc/cont-finish.d
cat >/etc/cont-finish.d/50-tailscale-logout <<'EOF'
#!/usr/bin/with-contenv bash
set -euo pipefail
tailscale logout >/dev/null 2>&1 || true
EOF
chmod +x /etc/cont-finish.d/50-tailscale-logout

echo "[tailscale-init] done"

